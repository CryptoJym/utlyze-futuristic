<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Mobile Menu Complete Test</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Critical mobile fixes inline for immediate application */
        @media (max-width: 900px) {
            /* Force menu hidden initially */
            .nav-links {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100vh !important;
                background: white !important;
                flex-direction: column !important;
                padding: 80px 20px 20px !important;
                z-index: 999998 !important;
                transform: translateX(-100%) !important;
                opacity: 0 !important;
                visibility: hidden !important;
                transition: transform 0.3s ease, opacity 0.3s ease !important;
                -webkit-transition: transform 0.3s ease, opacity 0.3s ease !important;
                -webkit-transform: translateX(-100%) !important;
            }
            
            /* Menu open state */
            .nav-links.nav-links--open {
                transform: translateX(0) !important;
                -webkit-transform: translateX(0) !important;
                opacity: 1 !important;
                visibility: visible !important;
            }
            
            /* Ensure toggle is visible */
            .nav-toggle {
                display: flex !important;
                position: relative !important;
                z-index: 999999 !important;
                background: transparent !important;
                border: none !important;
                padding: 8px !important;
                cursor: pointer !important;
                -webkit-tap-highlight-color: transparent !important;
                touch-action: manipulation !important;
            }
            
            /* Body states */
            body {
                -webkit-overflow-scrolling: touch !important;
            }
            
            body.menu-open {
                overflow: hidden !important;
                position: fixed !important;
                width: 100% !important;
            }
            
            /* Dark overlay */
            .menu-overlay {
                display: none;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 100% !important;
                background: rgba(0, 0, 0, 0.5) !important;
                z-index: 999997 !important;
                opacity: 0 !important;
                transition: opacity 0.3s ease !important;
            }
            
            .menu-overlay.active {
                display: block !important;
                opacity: 1 !important;
            }
            
            /* Nav links styling */
            .nav-link {
                display: block !important;
                padding: 15px 20px !important;
                font-size: 1.1rem !important;
                color: #333 !important;
                text-decoration: none !important;
                border-bottom: 1px solid rgba(0,0,0,0.1) !important;
            }
        }
        
        /* Debug panel */
        #debug-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #f0f0f0;
            border-top: 2px solid #333;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 11px;
            z-index: 999999;
        }
        
        .debug-entry {
            margin: 2px 0;
            padding: 2px 5px;
            background: white;
            border-left: 3px solid #007bff;
        }
        
        .debug-error {
            border-left-color: #dc3545;
            background: #fee;
        }
        
        .debug-success {
            border-left-color: #28a745;
            background: #efe;
        }
    </style>
</head>
<body>
    <div id="site-header-mount"></div>
    
    <!-- Menu overlay for better touch handling -->
    <div class="menu-overlay" id="menu-overlay"></div>
    
    <main style="padding: 2rem; max-width: 1200px; margin: 0 auto;">
        <h1>Mobile Menu Complete Test</h1>
        <p>This test includes all fixes and comprehensive debugging.</p>
        
        <h2>Test Status:</h2>
        <ul id="status-list">
            <li>Page loading...</li>
        </ul>
        
        <h2>Instructions:</h2>
        <ol>
            <li>Tap the hamburger menu (☰) button</li>
            <li>Menu should slide in from left</li>
            <li>Menu should STAY OPEN</li>
            <li>Tap outside to close</li>
            <li>Check debug panel for events</li>
        </ol>
        
        <button onclick="clearDebug()" style="padding: 10px 20px; margin: 20px 0;">Clear Debug Log</button>
    </main>
    
    <div id="site-footer-mount"></div>
    
    <div id="debug-panel"></div>
    
    <script>
        // Enhanced debug logging
        const debugPanel = document.getElementById('debug-panel');
        const statusList = document.getElementById('status-list');
        let debugEntries = [];
        
        function addDebug(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('en-US', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit', 
                fractionalSecondDigits: 3 
            });
            
            const entry = document.createElement('div');
            entry.className = `debug-entry${type === 'error' ? ' debug-error' : type === 'success' ? ' debug-success' : ''}`;
            entry.textContent = `[${timestamp}] ${message}`;
            debugPanel.insertBefore(entry, debugPanel.firstChild);
            
            // Keep only last 50 entries
            if (debugPanel.children.length > 50) {
                debugPanel.removeChild(debugPanel.lastChild);
            }
            
            // Also log to console
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function clearDebug() {
            debugPanel.innerHTML = '';
            addDebug('Debug log cleared', 'success');
        }
        
        function addStatus(message) {
            const li = document.createElement('li');
            li.textContent = message;
            statusList.appendChild(li);
        }
        
        // Override console methods
        const origLog = console.log;
        const origError = console.error;
        const origWarn = console.warn;
        
        console.log = function(...args) {
            addDebug(args.join(' '), 'info');
            origLog.apply(console, args);
        };
        
        console.error = function(...args) {
            addDebug(args.join(' '), 'error');
            origError.apply(console, args);
        };
        
        console.warn = function(...args) {
            addDebug(args.join(' '), 'warn');
            origWarn.apply(console, args);
        };
        
        // Device detection
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        
        addDebug(`Device: ${isMobile ? 'Mobile' : 'Desktop'}, Touch: ${isTouchDevice ? 'Yes' : 'No'}`, 'info');
        addDebug(`User Agent: ${navigator.userAgent}`, 'info');
        addDebug(`Screen: ${window.innerWidth}x${window.innerHeight}`, 'info');
    </script>
    
    <!-- Load app.js -->
    <script src="app.js"></script>
    
    <!-- Comprehensive mobile menu fix -->
    <script>
        (function() {
            'use strict';
            
            addDebug('Starting mobile menu initialization...', 'info');
            
            let initAttempts = 0;
            const maxAttempts = 10;
            let menuToggle = null;
            let navMenu = null;
            let overlay = null;
            let isMenuOpen = false;
            let touchStartTime = 0;
            
            function initMobileMenu() {
                initAttempts++;
                addDebug(`Init attempt ${initAttempts}/${maxAttempts}`, 'info');
                
                menuToggle = document.querySelector('.nav-toggle');
                navMenu = document.querySelector('.nav-links');
                overlay = document.getElementById('menu-overlay');
                
                if (!menuToggle || !navMenu) {
                    if (initAttempts < maxAttempts) {
                        addDebug('Elements not found, retrying...', 'warn');
                        setTimeout(initMobileMenu, 500);
                    } else {
                        addDebug('Failed to find menu elements after max attempts', 'error');
                    }
                    return;
                }
                
                addDebug('Menu elements found!', 'success');
                addStatus('✅ Navigation elements loaded');
                
                // Remove ALL existing listeners by cloning
                const newToggle = menuToggle.cloneNode(true);
                menuToggle.parentNode.replaceChild(newToggle, menuToggle);
                menuToggle = newToggle;
                
                // Ensure initial state
                navMenu.classList.remove('nav-links--open');
                menuToggle.classList.remove('nav-toggle--active');
                menuToggle.setAttribute('aria-expanded', 'false');
                document.body.classList.remove('menu-open');
                if (overlay) overlay.classList.remove('active');
                
                addDebug('Initial state set', 'info');
                
                // Menu control functions
                function openMenu() {
                    if (isMenuOpen) return;
                    
                    isMenuOpen = true;
                    navMenu.classList.add('nav-links--open');
                    menuToggle.classList.add('nav-toggle--active');
                    menuToggle.setAttribute('aria-expanded', 'true');
                    document.body.classList.add('menu-open');
                    if (overlay) overlay.classList.add('active');
                    
                    addDebug('Menu opened', 'success');
                    addStatus('✅ Menu opened');
                }
                
                function closeMenu() {
                    if (!isMenuOpen) return;
                    
                    isMenuOpen = false;
                    navMenu.classList.remove('nav-links--open');
                    menuToggle.classList.remove('nav-toggle--active');
                    menuToggle.setAttribute('aria-expanded', 'false');
                    document.body.classList.remove('menu-open');
                    if (overlay) overlay.classList.remove('active');
                    
                    addDebug('Menu closed', 'success');
                    addStatus('✅ Menu closed');
                }
                
                function toggleMenu(e) {
                    if (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                    }
                    
                    addDebug(`Toggle triggered, current state: ${isMenuOpen ? 'open' : 'closed'}`, 'info');
                    
                    if (isMenuOpen) {
                        closeMenu();
                    } else {
                        openMenu();
                    }
                    
                    return false;
                }
                
                // Touch events for mobile
                if (isTouchDevice) {
                    menuToggle.addEventListener('touchstart', function(e) {
                        touchStartTime = Date.now();
                        addDebug('Touch start on toggle', 'info');
                    }, { passive: true });
                    
                    menuToggle.addEventListener('touchend', function(e) {
                        const touchDuration = Date.now() - touchStartTime;
                        addDebug(`Touch end on toggle (duration: ${touchDuration}ms)`, 'info');
                        
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        
                        // Small delay to prevent double triggers
                        setTimeout(() => toggleMenu(e), 50);
                        
                        return false;
                    }, { passive: false });
                }
                
                // Click events as fallback
                menuToggle.addEventListener('click', function(e) {
                    addDebug('Click on toggle', 'info');
                    
                    // Ignore clicks if touch was just handled
                    if (isTouchDevice && (Date.now() - touchStartTime) < 300) {
                        addDebug('Ignoring click after recent touch', 'info');
                        e.preventDefault();
                        return false;
                    }
                    
                    toggleMenu(e);
                    return false;
                }, { capture: true });
                
                // Close on overlay click
                if (overlay) {
                    overlay.addEventListener('click', function(e) {
                        addDebug('Overlay clicked', 'info');
                        if (isMenuOpen) {
                            closeMenu();
                        }
                    });
                }
                
                // Close on outside click (with delay)
                document.addEventListener('click', function(e) {
                    if (!isMenuOpen) return;
                    
                    // Check if click is outside menu and toggle
                    if (!navMenu.contains(e.target) && !menuToggle.contains(e.target)) {
                        addDebug('Document click outside menu', 'info');
                        
                        // Delay to prevent immediate closing
                        setTimeout(() => {
                            if (isMenuOpen && !navMenu.contains(e.target) && !menuToggle.contains(e.target)) {
                                closeMenu();
                            }
                        }, 100);
                    }
                }, true);
                
                // Close on nav link click
                const navLinks = navMenu.querySelectorAll('.nav-link');
                navLinks.forEach(link => {
                    link.addEventListener('click', function() {
                        addDebug(`Nav link clicked: ${this.textContent}`, 'info');
                        closeMenu();
                    });
                });
                
                // Escape key handling
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && isMenuOpen) {
                        addDebug('Escape key pressed', 'info');
                        closeMenu();
                        menuToggle.focus();
                    }
                });
                
                addDebug('Mobile menu initialization complete!', 'success');
                addStatus('✅ All event handlers attached');
                addStatus('✅ Menu ready for testing');
            }
            
            // Start initialization
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initMobileMenu);
            } else {
                setTimeout(initMobileMenu, 100);
            }
        })();
    </script>
</body>
</html>